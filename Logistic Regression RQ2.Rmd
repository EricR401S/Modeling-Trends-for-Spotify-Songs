---
title: "Untitled"
author: "Eric Rios"
date: "2022-11-11"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Load Libraries
library(ggplot2)
library(psych)
library(corrplot)
library(dplyr)
library(table1)
library(boot)
```

```{r subset, echo = FALSE, message=FALSE, results = FALSE}
#read original data set
df <- read.csv("https://github.com/EricR401S/Modeling-Trends-for-Spotify-Songs/raw/main/archive/tracks.csv")
```

```{r datacleaning, echo = FALSE, message=FALSE, results = FALSE }
#Two columns of interest : Name of artist (if one wanted to highlight certain summary statistics), duration conversion (get minutes), the rest is perfect on its own. 

# Confirming the data types of the columns
sapply(df, class)

# Removing the brackets from the names of the artists
# This will facilitate summary statistics

df$artists<-gsub("]","",as.character(df$artists))
df$artists<-gsub("^.","",as.character(df$artists))

# New minute variable for our own use to simplify interpretation

df$duration_minutes <- df$duration_ms/(1000*60)


# Confirming that there are no missing data, except the artist name column

colSums(is.na(df))

# change "explicit" into binary factor
df$explicit_fac <- factor(df$explicit,
                         levels=c(0,1),
                         labels=c('Non-Explicit','Explicit'))

# make Date readable to R
# Emma and Eric need to revise this together, some records with Dates passed as NAs in R after running this code.
# That's the theory. It was single year dates.
df$release_year <- substr(df$release_date, 1, 4)
df$release_year <- as.integer(df$release_year)

#df$release_date <- as.Date(df$release_date, "%Y-%m-%d")

# According to variable definitions, speechiness levels above 0.66 are speech tracks such as podcasts and poetries.
# They will be removed.


df0 <- df[df$speechiness <= 0.66,]
nrow(df) - nrow(df0) #22,598 records of speech tracks

# Examining records with a value of 0 for tempo
# A total of 328 records with 0 tempo were found, and most were tracks of rain sounds and introductions. 
# Some were, unfortunately, real songs.

sum(df0$tempo==0)

# 148 of those records are from the 2010s decade, our area of interest. 
tempo_0_subset <- df0[df0$tempo == 0,]
tempo_0_subset_2010s <- tempo_0_subset[grep('201[0-9].*', tempo_0_subset$release_date),]
nrow(tempo_0_subset_2010s)

# Removing records with a value of 0 for tempo

df0 <- df0[df0$tempo != 0,]
```

```{r, echo = FALSE, message=FALSE, results = FALSE }
#subset data
subset <- df0[grepl('201[0-9].*', df0$release_year),]
```

```{r , echo=FALSE,results="asis", header=FALSE, message=FALSE, warning=FALSE}
RQ1_relation <- c("popularity", "acousticness", "danceability", "energy", "instrumentalness", "tempo", "loudness", "speechiness")
df1 = subset[RQ1_relation]
RQ2_relation <- c("explicit_fac", "danceability", "energy", "speechiness","tempo", "release_year")
df2 = subset[RQ2_relation]
```

```{r}
df2$explicit_fac <- factor(df2$explicit_fac)
keeps <- c("explicit_fac", "danceability", "energy", "speechiness", "tempo")
df2 <- df2[keeps]
```

```{r}
train <- df2[df2$release_year < 2017,]
test <- df2[df2$release_year >= 2017,]
keeps <- c("explicit_fac", "danceability", "energy", "speechiness", "tempo")
test <- test[keeps]
train <- train[keeps]
```

```{r}
r2 <- glm(explicit_fac ~ ., data = train , family = binomial(link = logit))
test_fitted <- predict(r2, newdata = test, type = "response")
test_fitted <- ifelse(test_fitted >= 0.5, "Non-Explicit", "Explicit")
Conf_mat3 <- confusionMatrix(as.factor(test_fitted), test$explicit_fac)
ConfMat3 <- as.data.frame.matrix(Conf_mat3$table)
Accuracy3 <- Conf_mat3$overall["Accuracy"]
stargazer(ConfMat3, summary = FALSE, type = "text", title = "Confusion Matrix")
stargazer(Accuracy3, type = "text", summary = FALSE)
```

```{r}
r2 <- glm(explicit_fac ~ ., data = df2 , family = binomial(link = logit))

Conf_mat <- confusionMatrix(as.factor(ifelse(fitted(r2) >= 0.5, "Non-Explicit", "Explicit")), df2$explicit_fac, positive = "Explicit")
ConfMat <- as.data.frame.matrix(Conf_mat$table)
Accuracy <- Conf_mat$overall["Accuracy"]

stargazer(ConfMat, summary = FALSE, type = "text", title = "confusion matrix", header = FALSE)
stargazer(Accuracy, type = "text", summary = FALSE, header = FALSE) 

invisible(roc(df2$explicit_fac,fitted(r2),plot=T,print.thres="best",legacy.axes=T, print.auc =T,col="red3"))
```
```{r}
a <- vif(r2) 
stargazer(a, type = "text", summary = FALSE)
```

